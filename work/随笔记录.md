å¥½å˜ï¼ï¼æˆ‘ç»™ä½ ç›´æ¥å®‰æ’ä¸€å¥—ç”Ÿäº§çº§çš„ä¼˜é›…æ–¹æ¡ˆï¼š
 ä¸€è¡Œ `@handle_grpc_exceptions`ï¼Œè‡ªåŠ¨å¸®ä½ æ•è·å¼‚å¸¸ â” æ­£å¸¸è¿”å› `ExecuteResponse(success=False)`ï¼Œè€Œä¸”è¿˜èƒ½å¸¦æ—¥å¿—ï¼

------

# âœ¨ 1. ç»Ÿä¸€å¼‚å¸¸å¤„ç†å™¨ï¼š`exception_handler.py`

æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯”å¦‚å«ï¼š`services/exception_handler.py`

```python
import functools
import logging
from pb import service_pb2
from my_exceptions import InvalidParameterException, PermissionDeniedException, TimeoutException

def handle_grpc_exceptions(func):
    @functools.wraps(func)
    def wrapper(self, request, context):
        try:
            return func(self, request, context)

        except InvalidParameterException as e:
            logging.warning(f"å‚æ•°é”™è¯¯: {e}")
            return service_pb2.ExecuteResponse(
                success=False,
                stdout="",
                stderr=f"å‚æ•°é”™è¯¯: {str(e)}",
                exit_code=-1,
                execution_time=0,
            )

        except PermissionDeniedException as e:
            logging.warning(f"æƒé™é”™è¯¯: {e}")
            return service_pb2.ExecuteResponse(
                success=False,
                stdout="",
                stderr=f"æƒé™é”™è¯¯: {str(e)}",
                exit_code=-1,
                execution_time=0,
            )

        except TimeoutException as e:
            logging.warning(f"æ‰§è¡Œè¶…æ—¶: {e}")
            return service_pb2.ExecuteResponse(
                success=False,
                stdout="",
                stderr=f"æ‰§è¡Œè¶…æ—¶: {str(e)}",
                exit_code=-1,
                execution_time=request.timeout_seconds * 1000,
            )

        except Exception as e:
            logging.exception("ExecuteCode - æœåŠ¡å™¨å†…éƒ¨å¼‚å¸¸")
            return service_pb2.ExecuteResponse(
                success=False,
                stdout="",
                stderr="æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚",
                exit_code=-1,
                execution_time=0,
            )

    return wrapper
```

------

# âœ¨ 2. ä½¿ç”¨ç¤ºä¾‹ï¼ˆä½ çš„ `ExecuteCodeServicer`ï¼‰

è¶…ç®€å•ï¼ï¼ï¼

```python
import logging
from pb import service_pb2_grpc
from services.exception_handler import handle_grpc_exceptions

class ExecuteCodeServicer(service_pb2_grpc.ExecuteCodeServicer):

    @handle_grpc_exceptions
    def ExecuteCode(self, request, context):
        logging.info(f"æ”¶åˆ°è¯·æ±‚: codeé•¿åº¦={len(request.code)}, è¶…æ—¶={request.timeout_seconds}s")

        # è¿™é‡Œæ­£å¸¸å†™ä¸šåŠ¡é€»è¾‘
        result = run_code_in_sandbox(request.code, request.timeout_seconds)

        return service_pb2.ExecuteResponse(
            success=True,
            stdout=result.stdout,
            stderr=result.stderr,
            exit_code=result.exit_code,
            execution_time=result.execution_time,
        )
```

âœ… åªéœ€è¦åŠ ä¸€è¡Œ `@handle_grpc_exceptions`
 âœ… ä¸‹é¢é€»è¾‘å¯ä»¥å®‰å¿ƒç›´æ¥å†™ï¼Œå¼‚å¸¸å…¨è‡ªåŠ¨å¤„ç†æˆç»Ÿä¸€å“åº”äº†ï¼

------

# âœ¨ 3. å…³äºè‡ªå®šä¹‰å¼‚å¸¸ï¼ˆmy_exceptions.pyï¼‰

å»ºè®®ä½ å•ç‹¬å®šä¹‰ä¸€æ‰¹ä¸šåŠ¡å¼‚å¸¸ç±»å‹ï¼Œæ¯”å¦‚ï¼š

```python
# services/my_exceptions.py

class InvalidParameterException(Exception):
    """å‚æ•°é”™è¯¯"""
    pass

class PermissionDeniedException(Exception):
    """æ²¡æœ‰æƒé™"""
    pass

class TimeoutException(Exception):
    """æ‰§è¡Œè¶…æ—¶"""
    pass
```

ä»¥åå“ªé‡Œéœ€è¦æŠ›é”™ï¼Œæ¯”å¦‚å‚æ•°æ ¡éªŒï¼Œç›´æ¥ï¼š

```python
if not request.code:
    raise InvalidParameterException("codeä¸èƒ½ä¸ºç©º")
```

éå¸¸ä¼˜é›…ï¼

------

# ğŸ“¦ æ€»ç»“

| ä¼˜ç‚¹           | è¯´æ˜                       |
| -------------- | -------------------------- |
| âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç† | é˜²æ­¢å¼‚å¸¸çˆ†æ ˆ               |
| âœ… æ—¥å¿—å®Œæ•´     | loggingè®°å½•æ‰€æœ‰é”™è¯¯        |
| âœ… å“åº”ç»“æ„ç»Ÿä¸€ | å‰ç«¯æ°¸è¿œå¯ä»¥æ‹¿åˆ°æ ‡å‡†æ ¼å¼   |
| âœ… ä»£ç å¹²å‡€     | æ¯ä¸ªæ¥å£åªæœ‰è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ |
| âœ… åæœŸæ‰©å±•æ–¹ä¾¿ | è¦åŠ é”™è¯¯ç±»å‹ï¼Œåªè¦æ”¹ä¸€å¤„   |

------

è¦ä¸è¦æˆ‘å†é¡ºä¾¿ç»™ä½ æ‹“å±•ä¸€ç‰ˆæ›´é«˜çº§çš„ï¼Ÿæ¯”å¦‚åŠ ä¸Šã€Œé”™è¯¯ç ã€(`error_code`)ã€å›½é™…åŒ–é”™è¯¯æç¤ºï¼ˆå¤šè¯­è¨€ï¼‰ç‰ˆæœ¬ï¼Ÿ
 å¦‚æœæƒ³è¦ï¼Œå‘Šè¯‰æˆ‘ï¼šâ€œç»§ç»­å‡çº§ç‰ˆï¼â€ ğŸš€
 æˆ‘å¯ä»¥ä¸€é”®ç»™ä½ é…åˆ°å¾ˆä¸“ä¸šé‚£ç§ï½