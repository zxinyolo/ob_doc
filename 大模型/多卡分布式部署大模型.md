#### 安装docker

```shell
#安装 nvidia-docker：
sudo apt-get install nvidia-docker2

#然后重启 Docker：
sudo systemctl restart docker
```

- docker安装失败?

  ```shell
  // 添加官方 NVIDIA Docker 仓库
  distribution=$(. /etc/os-release;echo $ID$VERSION_ID)  # 获取 Ubuntu 版本
  curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | \
      sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
      sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
      
  sudo apt update
  
  sudo apt install -y nvidia-docker2
  
  sudo systemctl restart docker
  ```

  



#### 本地拉取大模型

```shell
huggingface-cli download unsloth/DeepSeek-R1-Distill-Llama-70B --local-dir ./deepseek-r1-70B
```

- 下载的目录没有权限?

  ```shell
  // 获取下载目录存储权限
  sudo chown -R mars:mars /data
  sudo chmod -R 775 /data
  ```

  

#### dockerfile

```dockerfile
# 选用一个基础镜像，这里使用 NVIDIA 的 CUDA 12.4 镜像，提供最新的 GPU 支持。
ARG base=nvidia/cuda:12.4.0-runtime-ubuntu22.04

# 从我们之前选好的“起点”开始。
FROM ${base}

# 设定 Conda 版本，这里使用 Python 3.10 的 Miniconda 版本。
ARG CONDA_VERSION=py310_24.1.2-0

# 设定 Miniconda 下载地址，使用清华大学镜像加速下载。
ARG MINICONDA_BASE_URL=https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/

# 设置环境变量，确保非交互式安装和 UTF-8 编码。
ENV DEBIAN_FRONTEND=noninteractive LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

# 更新软件包，并安装 wget、git 等必要工具。
RUN apt update && \
    apt install -y --no-install-recommends \
    wget \
    git \
    build-essential \
    ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 根据架构下载相应的 Miniconda 安装包，并验证 SHA256 校验和。
RUN set -x && \
    UNAME_M="$(uname -m)" && \
    if [ "${UNAME_M}" = "x86_64" ]; then \
    MINICONDA_URL="${MINICONDA_BASE_URL}/Miniconda3-${CONDA_VERSION}-Linux-x86_64.sh"; \
    SHA256SUM="2baed84b08706d8f5f2d8f962e86f5c5f3794f2c537346d7eb3a8d9dd5e58ac9"; \
    elif [ "${UNAME_M}" = "s390x" ]; then \
    MINICONDA_URL="${MINICONDA_BASE_URL}/Miniconda3-${CONDA_VERSION}-Linux-s390x.sh"; \
    SHA256SUM="8c73e8e2d7e8b2d2e5f0fbee0e131f91f0f73bf0e70c0e09349f9e653d45ef27"; \
    elif [ "${UNAME_M}" = "aarch64" ]; then \
    MINICONDA_URL="${MINCONDA_BASE_URL}/Miniconda3-${CONDA_VERSION}-Linux-aarch64.sh"; \
    SHA256SUM="d058d9030bfa0e7ebdd7eb1333b0e9915e9b2a8aa926c87a26fbed046dc4e91e"; \
    elif [ "${UNAME_M}" = "ppc64le" ]; then \
    MINICONDA_URL="${MINICONDA_BASE_URL}/Miniconda3-${CONDA_VERSION}-Linux-ppc64le.sh"; \
    SHA256SUM="6b57cd3e14966b8497e989c3bd7a6827f8a88c467d723bd0c717e21e7c97e832"; \
    fi && \
    wget "${MINICONDA_URL}" -O miniconda.sh -q && \
    echo "${SHA256SUM} miniconda.sh" > shasum && \
    if [ "${CONDA_VERSION}" != "latest" ]; then sha256sum --check --status shasum; fi && \
    mkdir -p /opt && \
    bash miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh shasum && \
    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc && \
    echo "conda activate base" >> ~/.bashrc && \
    find /opt/conda/ -follow -type f -name '*.a' -delete && \
    find /opt/conda/ -follow -type f -name '*.js.map' -delete && \
    /opt/conda/bin/conda clean -afy

# 设置 Python 的环境变量。
ENV PYTHON_PREFIX=/opt/conda/bin

# 更新 Python、pip 的可执行路径。
RUN update-alternatives --install /usr/bin/python python ${PYTHON_PREFIX}/python 1 && \
    update-alternatives --install /usr/bin/python3 python3 ${PYTHON_PREFIX}/python3 1 && \
    update-alternatives --install /usr/bin/pip pip ${PYTHON_PREFIX}/pip 1 && \
    update-alternatives --install /usr/bin/pip3 pip3 ${PYTHON_PREFIX}/pip3 1

# 创建工作目录。
RUN mkdir -p /workspace

# 配置 pip 使用国内源，加速下载。
RUN pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 安装核心依赖，包括 transformers 和 Ray。
RUN pip3 install transformers>=4.37.0 accelerate tiktoken einops scipy transformers_stream_generator==0.0.4 peft deepspeed fschat ray==2.30.0

# 安装 xformers，无依赖安装以避免冲突。
RUN pip3 install xformers --no-deps

# 安装 vLLM，并清除 pip 缓存。
RUN pip3 install vllm==0.6.1.post2 && \
    pip3 cache purge

# 设置工作目录。
WORKDIR /workspace

# 设置入口点，默认监听 8000 端口。
ENTRYPOINT ["python", "-m", "vllm.entrypoints.openai.api_server", "--host", "0.0.0.0", "--port", "8000"]
```

- docker build -t deepseek-70b-server .