> 以下步骤前提:
>
> 1.两台机器,每台机器八张4090显卡,每张显卡24G
>
> 2.部署模型为unsloth/DeepSeek-R1-Distill-Llama-70B

#### 步骤1: 拉取大模型

每台机器都需要拉取大模型(一台下载后可以使用scp传输到其它机器),存放位置一致,比如/data下

```shell
cd /data
huggingface-cli download unsloth/DeepSeek-R1-Distill-Llama-70B --local-dir ./deepseek-r1-70B
```



#### 步骤2: 安装docker

每台机器都需要

如果docker 镜像默认存储路径空间不够需要更换docker镜像存储路径

```shell
#安装 nvidia-docker：
sudo apt-get install nvidia-docker2

#然后重启 Docker：
sudo systemctl restart docker
```



#### 步骤3: docker拉取vllm官方镜像

每台机器都需要拉取

```shell
docker pull vllm/vllm-openai:latest
```



#### 步骤4: 编写运行docker镜像脚本

每台机器都需要,存储路径一致,比如/data/docker_data/run_cluster.sh

```shell
#!/bin/bash

# Ensure there are enough arguments
if [ $# -lt 4 ]; then
    echo "Usage: $0 docker_image head_node_address --head|--worker path_to_hf_home [additional_args...]"
    exit 1
fi

# Assign variables
DOCKER_IMAGE="$1"
HEAD_NODE_ADDRESS="$2"
NODE_TYPE="$3"  # --head or --worker
PATH_TO_HF_HOME="$4"
shift 4

# Additional arguments are passed to the docker command
ADDITIONAL_ARGS=("$@")

# Validate the node type
if [ "${NODE_TYPE}" != "--head" ] && [ "${NODE_TYPE}" != "--worker" ]; then
    echo "Error: Node type must be --head or --worker"
    exit 1
fi

# Define the Ray command based on node type
RAY_START_CMD="ray start --block"
if [ "${NODE_TYPE}" == "--head" ]; then
    RAY_START_CMD+=" --head --port=6379"
else
    RAY_START_CMD+=" --address=${HEAD_NODE_ADDRESS}:6379"
fi

# Docker run command
docker run -d \
    --entrypoint /bin/bash \
    --network host \
    --name node \
    --shm-size 10.24g \
    --gpus all \
    -v "${PATH_TO_HF_HOME}:/root/.cache/huggingface" \
    "${ADDITIONAL_ARGS[@]}" \
    "${DOCKER_IMAGE}" -c "
    ${RAY_START_CMD} &
    tail -f /dev/null"  # Keep the container running

```



#### 步骤5: 运行run_cluster.sh脚本启动docker 容器

需要注意: 主节点和从节点运行的命令不一样

```shell
# 这里10.100.1.205 是主机器, 10.100.1.209是从机器
# 主机器运行
sudo bash run_cluster.sh vllm/vllm-openai 10.100.1.205 --head /data/deepseek-r1-70B -v /data/deepseek-r1-70B:/data/deepseek-r1-70B -e GLOO_SOCKET_IFNAME=ens6f0np0 -e NCCL_SOCKET_IFNAME=ens6f0np0 -e VLLM_HOST_IP=10.100.1.205
# 从机器运行
bash run_cluster.sh vllm/vllm-openai 10.100.1.205 --worker /data/deepseek-r1-70B -v /data/deepseek-r1-70B:/data/deepseek-r1-70B -e GLOO_SOCKET_IFNAME=ens6f0np0 -e NCCL_SOCKET_IFNAME=ens6f0np0 -e VLLM_HOST_IP=10.100.1.209

#  vllm/vllm-openai   镜像名称
#  10.100.1.205 主机器ip
#  --head 代表是主机器
#  --worker 代表从机器
#  /data/deepseek-r1-70B  模型路径
# -v /data/deepseek-r1-70B:/data/deepseek-r1-70B 宿主机本地模型映射到容器内
#  -e GLOO_SOCKET_IFNAME=ens6f0np0 服务器ip对应的网卡名称
#  -e NCCL_SOCKET_IFNAME=ens6f0np0 服务器ip对应的网卡名称
#  -e VLLM_HOST_IP=10.100.1.205 当前机器ip

```



#### 步骤6: 

























